name: ğŸ§ª Pipeline Validation

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of validation test to run'
        required: true
        default: 'basic'
        type: choice
        options:
          - basic
          - full
          - security-only
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - 'docker-compose.test.yml'
      - 'Dockerfile'

env:
  TEST_DATABASE_URL: "postgresql://testuser:testpass@localhost:5432/testdb"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”§ PIPELINE VALIDATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-workflows:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ğŸ” Install actionlint
      run: |
        bash <(curl https://raw.githubusercontent.com/rhymond/actionlint/main/scripts/download-actionlint.bash)
        sudo mv actionlint /usr/local/bin/
    
    - name: âœ… Validate GitHub Actions Workflows
      run: |
        echo "ğŸ” Validating all workflow files..."
        actionlint .github/workflows/*.yml
        
        echo "âœ… All workflow files are valid!"
    
    - name: ğŸ“‹ Workflow Summary
      run: |
        echo "## ğŸ” Workflow Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Workflows Found:" >> $GITHUB_STEP_SUMMARY
        
        for workflow in .github/workflows/*.yml; do
          name=$(grep "^name:" "$workflow" | head -1 | cut -d'"' -f2 || echo "Unknown")
          echo "- **$(basename "$workflow")**: $name" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **All workflows validated successfully!**" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ³ DOCKER VALIDATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-containers:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type != 'security-only'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ§ª Test Docker Build
      run: |
        echo "ğŸ—ï¸ Testing multi-stage Docker build..."
        docker build -t proj:validation-test .
        
        echo "ğŸ” Inspecting built image..."
        docker images proj:validation-test
        docker inspect proj:validation-test
    
    - name: ğŸ§ª Test Docker Compose
      run: |
        echo "ğŸ³ Testing Docker Compose setup..."
        
        # Test production compose
        docker-compose config
        
        # Test integration test compose
        if [ -f docker-compose.test.yml ]; then
          docker-compose -f docker-compose.test.yml config
          echo "âœ… Test compose configuration valid"
        fi
    
    - name: ğŸ” Container Security Check
      run: |
        echo "ğŸ›¡ï¸ Basic container security validation..."
        
        # Check if non-root user is used
        if docker run --rm proj:validation-test whoami | grep -q "appuser"; then
          echo "âœ… Container runs as non-root user"
        else
          echo "âš ï¸ Container may be running as root"
        fi
        
        # Check for health check
        if docker inspect proj:validation-test | grep -q "HEALTHCHECK"; then
          echo "âœ… Health check configured"
        else
          echo "âš ï¸ No health check found"
        fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” SECURITY VALIDATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-security:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'security-only' || github.event.inputs.test_type == 'full'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ” Check for Secrets
      run: |
        echo "ğŸ” Scanning for potential secrets..."
        
        # Basic secret patterns
        if grep -r -i "password.*=" --include="*.py" --include="*.js" --exclude-dir=node_modules . | grep -v "PASSWORD_" | grep -v test; then
          echo "âš ï¸ Potential hardcoded passwords found"
          exit 1
        else
          echo "âœ… No hardcoded passwords detected"
        fi
        
        # API key patterns
        if grep -r -E "(api_key|apikey).*=" --include="*.py" --include="*.js" --exclude-dir=node_modules . | grep -v "API_KEY"; then
          echo "âš ï¸ Potential hardcoded API keys found"
          exit 1
        else
          echo "âœ… No hardcoded API keys detected"
        fi
    
    - name: ğŸ” Validate .gitignore
      run: |
        echo "ğŸ” Checking .gitignore for security patterns..."
        
        if grep -q "\.env" .gitignore; then
          echo "âœ… .env files are ignored"
        else
          echo "âš ï¸ .env files not in .gitignore"
          exit 1
        fi
        
        if grep -q "node_modules" .gitignore; then
          echo "âœ… node_modules ignored"
        else
          echo "âš ï¸ node_modules should be in .gitignore"
        fi
    
    - name: ğŸ” Check File Permissions
      run: |
        echo "ğŸ” Checking for files with sensitive permissions..."
        
        # Check for executable files that shouldn't be
        find . -name "*.py" -executable -type f | head -5 | while read file; do
          echo "âš ï¸ Python file with execute permission: $file"
        done
        
        # Check for world-writable files
        find . -type f -perm -002 | head -5 | while read file; do
          echo "âš ï¸ World-writable file: $file"
        done
        
        echo "âœ… File permission check completed"
    
    - name: ğŸ“‹ Security Summary
      run: |
        echo "## ğŸ” Security Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Checks Performed:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Secret pattern scanning" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… .gitignore validation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… File permission checks" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Container security basics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **All security validations passed!**" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š PIPELINE HEALTH CHECK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  health-check:
    runs-on: ubuntu-latest
    needs: [validate-workflows, validate-containers, validate-security]
    if: always()
    
    steps:
    - name: ğŸ“Š Pipeline Health Summary
      run: |
        echo "## ğŸ¥ Pipeline Health Check Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Component Status:" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflows**: ${{ needs.validate-workflows.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Containers**: ${{ needs.validate-containers.result }}" >> $GITHUB_STEP_SUMMARY  
        echo "- **Security**: ${{ needs.validate-security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.validate-workflows.result }}" == "success" ] && 
           [ "${{ needs.validate-containers.result }}" == "success" ] && 
           [ "${{ needs.validate-security.result }}" == "success" ]; then
          echo "ğŸ‰ **Overall Status: HEALTHY** ğŸ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ready for:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Automated deployments" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security scanning" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Container orchestration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Free tier operations" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Overall Status: NEEDS ATTENTION**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review failed components above." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Pipeline validation completed at $(date)*" >> $GITHUB_STEP_SUMMARY
